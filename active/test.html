<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>OFP Browser</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="icon" type="image/x-icon" href="logo.png" />
    <link rel="shortcut icon" type="image/jpg" href="logo.png" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap" rel="stylesheet" />
    
    <!-- CUSTOMIZABLE CSS - Easy to modify styles -->
    <style id="custom-styles">
      /* Base Elements */
      :root {
        --bg-color: #1a1a1a;
        --text-color: #fff;
        --navbar-bg: rgba(15, 15, 15, 0.8);
        --navbar-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        --button-bg: rgba(10, 10, 10, 0.8);
        --button-hover-bg: rgba(15, 15, 15, 0.9);
        --search-bg: rgba(10, 10, 10, 0.8);
        --search-focus-bg: rgba(45, 45, 45, 0.9);
        --search-focus-shadow: 0 0 0 3px rgba(255, 255, 255, 0.3);
        --iframe-bg: #202020;
        --footer-text-color: #fff;
        --font-family-main: 'Roboto Mono', monospace;
        --font-family-alt: 'Roboto Mono', monospace;
        --tab-bg: rgba(25, 25, 25, 0.8);
        --tab-active-bg: rgba(45, 45, 45, 0.9);
        --tab-border: rgba(60, 60, 60, 0.5);
        --tab-hover-bg: rgba(35, 35, 35, 0.9);
      }

      html, body {
        margin: 0;
        padding: 0;
        border: none;
        box-sizing: border-box;
        width: 100%;
        height: 100%;
        overflow: hidden;
        font-family: var(--font-family-main);
        background-color: var(--bg-color);
        color: var(--text-color);
      }
      
      body {
        display: flex;
        flex-direction: column;
      }
      
      /* Tab Bar */
      #tab-bar {
        display: flex;
        background-color: var(--navbar-bg);
        padding: 10px 12px;
        overflow-x: auto;
        white-space: nowrap;
        scrollbar-width: thin;
        position: relative;
        align-items: center;
        gap: 8px; /* Add consistent spacing between tabs */
      }
      
      #tab-bar::-webkit-scrollbar {
        height: 3px;
      }
      
      #tab-bar::-webkit-scrollbar-thumb {
        background-color: rgba(255, 255, 255, 0.3);
        border-radius: 3px;
      }
      
      .tab {
        display: flex;
        align-items: center;
        min-width: 160px;
        max-width: 200px;
        height: 32px;
        padding: 0 12px;
        background-color: var(--tab-bg);
        border-radius: 16px;
        cursor: pointer;
        transition: all 0.2s ease;
        overflow: hidden;
        position: relative;
        box-shadow: 0 0 0 1px var(--tab-border);
      }
      
      .tab.active {
        background-color: var(--tab-active-bg);
        box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.3);
      }
      
      .tab:hover:not(.active) {
        background-color: var(--tab-hover-bg);
      }
      
      .tab-favicon {
        width: 16px;
        height: 16px;
        margin-right: 8px;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .tab-title {
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-size: 12px;
      }
      
      .tab-close {
        width: 16px;
        height: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        margin-left: 4px;
        flex-shrink: 0;
        opacity: 0.7;
        transition: opacity 0.2s, background-color 0.2s;
      }
      
      .tab-close:hover {
        opacity: 1;
        background-color: rgba(255, 255, 255, 0.2);
      }
      
      .new-tab-button {
        width: 32px;
        height: 32px;
        min-width: 32px;
        margin-left: 6px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: var(--button-bg);
        cursor: pointer;
        transition: background-color 0.2s;
        box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.3);
      }
      
      .new-tab-button:hover {
        background-color: var(--button-hover-bg);
      }
      
      /* Navigation Bar */
      #nav-bar {
        display: flex;
        align-items: center;
        padding: 10px;
        background-color: var(--navbar-bg);
        box-shadow: var(--navbar-shadow);
      }
      
      /* Buttons */
      .nav-button {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 10px;
        border-radius: 50%;
        background-color: var(--button-bg);
        cursor: pointer;
        color: var(--text-color);
        transition: background-color 0.2s, color 0.2s;
        box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.5);
      }
      
      .nav-button:hover {
        background-color: var(--button-hover-bg);
      }
      
      /* Search Bar */
      #search-bar {
        flex: 1;
        height: 40px;
        border-radius: 30px;
        border: none;
        background-color: var(--search-bg);
        color: var(--text-color);
        padding: 0 18px;
        font-size: 15px;
        font-weight: 700;
        box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.5);
        font-family: var(--font-family-main);
      }
      
      #search-bar:focus {
        outline: none;
        background-color: var(--search-focus-bg);
        box-shadow: var(--search-focus-shadow);
        font-weight: 700;
      }
      
      /* Content Area */
      #tabs-container {
        flex: 1;
        position: relative;
        background-color: var(--iframe-bg);
      }
      
      .tab-content {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: none;
        border: none;
      }
      
      .tab-content.active {
        display: block;
      }
      
      /* Footer */
      .footer-label {
        position: fixed;
        bottom: 0;
        left: 0;
        margin: 1rem;
        font-family: var(--font-family-main);
        font-size: 0.9rem;
        color: var(--footer-text-color);
        text-decoration: none;
        z-index: 1000;
      }
      
      /* Background Canvas */
      canvas {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
      }
    </style>
  </head>
  <body>
    <canvas id="canvas"></canvas>
    <div id="tab-bar">
      <!-- Tabs will be dynamically added here -->
      <div class="new-tab-button" id="new-tab-button" title="New Tab">
        <i class="fas fa-plus"></i>
      </div>
    </div>
    <div id="nav-bar">
      <div class="nav-button" id="home-button" title="Home">
        <i class="fas fa-home"></i>
      </div>
      <div class="nav-button" id="back-button" title="Back">
        <i class="fas fa-arrow-left"></i>
      </div>
      <div class="nav-button" id="forward-button" title="Forward">
        <i class="fas fa-arrow-right"></i>
      </div>
      <div class="nav-button" id="refresh-button" title="Refresh">
        <i class="fas fa-redo"></i>
      </div>
      <div class="nav-button" id="foursp-button" title="4SP Dashboard">
        <img src="../4spicon.png" alt="4SP" style="width: 20px; height: 20px;">
      </div>
      <input type="text" id="search-bar" placeholder="Search DuckDuckGo or type a URL">
    </div>
    <div id="tabs-container">
      <!-- Tab content (iframes) will be dynamically added here -->
    </div>
    <a href="https://4simpleproblems.github.io/proxy-list.html" class="footer-label">Official 4SP Proxy</a>
    
    <script src="uv/uv.bundle.js" defer></script>
    <script src="uv/uv.config.js" defer></script>
    <script src="register-sw.js" defer></script>
    <script src="stars.js" defer></script>
    <script>
      // Tab Management
      let tabs = [];
      let activeTabId = null;
      let tabCounter = 0;
      
      // Initialize UV
      async function initUV() {
        try {
          await registerSW();
          console.log("Service worker registered");
        } catch (err) {
          console.error("Failed to register service worker:", err);
        }
      }
      
      // Create a new tab
      function createTab(url = null) {
        const tabId = `tab-${tabCounter++}`;
        const contentId = `content-${tabId}`;
        
        // Create tab element
        const tabElement = document.createElement('div');
        tabElement.className = 'tab';
        tabElement.dataset.tabId = tabId;
        tabElement.innerHTML = `
          <div class="tab-favicon">
            <i class="fas fa-globe" style="font-size: 14px;"></i>
          </div>
          <div class="tab-title">New Tab</div>
          <div class="tab-close">
            <i class="fas fa-times"></i>
          </div>
        `;
        
        // Insert before the new tab button
        const newTabButton = document.getElementById('new-tab-button');
        document.getElementById('tab-bar').insertBefore(tabElement, newTabButton);
        
        // Create iframe for tab content
        const iframe = document.createElement('iframe');
        iframe.id = contentId;
        iframe.className = 'tab-content';
        iframe.sandbox = 'allow-scripts allow-same-origin allow-forms allow-popups';
        document.getElementById('tabs-container').appendChild(iframe);
        
        // Add tab object to tabs array
        const tab = {
          id: tabId,
          contentId: contentId,
          element: tabElement,
          iframe: iframe,
          url: url || 'about:blank'
        };
        tabs.push(tab);
        
        // Add event listeners
        tabElement.addEventListener('click', (e) => {
          if (!e.target.closest('.tab-close')) {
            activateTab(tabId);
          }
        });
        
        tabElement.querySelector('.tab-close').addEventListener('click', (e) => {
          e.stopPropagation();
          closeTab(tabId);
        });
        
        // Set as active tab
        activateTab(tabId);
        
        // Navigate to URL if provided
        if (url) {
          navigateTo(url, tab);
        }
        
        return tab;
      }
      
      // Activate a tab
      function activateTab(tabId) {
        // Deactivate all tabs
        tabs.forEach(tab => {
          tab.element.classList.remove('active');
          tab.iframe.classList.remove('active');
        });
        
        // Activate the selected tab
        const tab = tabs.find(t => t.id === tabId);
        if (tab) {
          tab.element.classList.add('active');
          tab.iframe.classList.add('active');
          activeTabId = tabId;
          
          // Update search bar with tab's URL
          document.getElementById('search-bar').value = tab.url !== 'about:blank' ? tab.url : '';
          
          // Ensure tab is visible in the tab bar (scroll if needed)
          tab.element.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
      }
      
      // Close a tab
      function closeTab(tabId) {
        const tabIndex = tabs.findIndex(t => t.id === tabId);
        if (tabIndex === -1) return;
        
        const tab = tabs[tabIndex];
        
        // Remove elements
        tab.element.remove();
        tab.iframe.remove();
        
        // Remove from array
        tabs.splice(tabIndex, 1);
        
        // If the closed tab was active, activate another tab
        if (activeTabId === tabId) {
          if (tabs.length > 0) {
            // Activate the tab to the left, or the first tab if none to the left
            const newActiveTabIndex = Math.max(0, tabIndex - 1);
            activateTab(tabs[newActiveTabIndex].id);
          } else {
            // If no tabs left, create a new one
            createTab();
          }
        }
      }
      
      // Navigate to URL
      function navigateTo(url, tab = null) {
        if (!url) return;
        
        // Get the current active tab if none specified
        if (!tab) {
          tab = tabs.find(t => t.id === activeTabId);
          if (!tab && tabs.length > 0) {
            tab = tabs[0];
          }
          if (!tab) {
            tab = createTab();
          }
        }
        
        // Format URL
        let formattedUrl = url;
        if (!/^https?:\/\//i.test(url) && !url.startsWith('about:')) {
          if (/^([a-z0-9]([a-z0-9-]*[a-z0-9])?\.)+[a-z]{2,}$/i.test(url) ||
              /^(\d{1,3}\.){3}\d{1,3}$/i.test(url)) {
            formattedUrl = 'http://' + url;
          } else {
            // Use DuckDuckGo for searches
            formattedUrl = 'https://duckduckgo.com/?q=' + encodeURIComponent(url);
          }
        }
        
        try {
          const encodedUrl = __uv$config.prefix + __uv$config.encodeUrl(formattedUrl);
          tab.iframe.src = encodedUrl;
          tab.url = formattedUrl;
          document.getElementById('search-bar').value = formattedUrl;
        } catch (err) {
          console.error("Navigation error:", err);
        }
      }
      
      // Update tab information
      function updateTabInfo(tab, title, favicon) {
        if (!tab) return;
        
        // Update tab title
        const titleElement = tab.element.querySelector('.tab-title');
        if (titleElement) {
          titleElement.textContent = title || 'New Tab';
          titleElement.title = title || 'New Tab';
        }
        
        // Update favicon if provided
        if (favicon) {
          const faviconElement = tab.element.querySelector('.tab-favicon');
          if (faviconElement) {
            faviconElement.innerHTML = `<img src="${favicon}" alt="" style="width:16px;height:16px;">`;
          }
        }
      }
      
      // Theme customization function
      function customizeTheme(options) {
        const root = document.documentElement;
        for (const [key, value] of Object.entries(options)) {
          root.style.setProperty(`--${key}`, value);
        }
      }
      
      // Get current active tab
      function getActiveTab() {
        return tabs.find(t => t.id === activeTabId);
      }
      
      // Event Listeners
      document.addEventListener('DOMContentLoaded', async () => {
        // Initialize UV
        await initUV();
        
        // Create initial tab
        const urlParams = new URLSearchParams(window.location.search);
        const url = urlParams.get('url');
        createTab(url || null);
        
        // New tab button
        document.getElementById('new-tab-button').addEventListener('click', () => {
          createTab();
        });
        
        // Search bar
        document.getElementById('search-bar').addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            navigateTo(e.target.value);
          }
        });
        
        // Home button
        document.getElementById('home-button').addEventListener('click', () => {
          window.location.href = "index.html";
        });
        
        // Back button
        document.getElementById('back-button').addEventListener('click', () => {
          const tab = getActiveTab();
          if (tab) {
            try {
              tab.iframe.contentWindow.history.back();
            } catch (err) {
              console.error("Navigation error:", err);
            }
          }
        });
        
        // Forward button
        document.getElementById('forward-button').addEventListener('click', () => {
          const tab = getActiveTab();
          if (tab) {
            try {
              tab.iframe.contentWindow.history.forward();
            } catch (err) {
              console.error("Navigation error:", err);
            }
          }
        });
        
        // Refresh button
        document.getElementById('refresh-button').addEventListener('click', () => {
          const tab = getActiveTab();
          if (tab) {
            try {
              tab.iframe.contentWindow.location.reload();
            } catch (err) {
              console.error("Refresh error:", err);
              // Fallback: reload the current URL
              if (tab.url) navigateTo(tab.url, tab);
            }
          }
        });
        
        // 4SP Dashboard button
        document.getElementById('foursp-button').addEventListener('click', () => {
          window.location.href = 'https://4simpleproblems.github.io/dashboard.html';
        });
        
        // Listen for iframe load events to update tab info
        document.getElementById('tabs-container').addEventListener('load', (e) => {
          if (e.target.tagName === 'IFRAME') {
            const contentId = e.target.id;
            const tab = tabs.find(t => t.contentId === contentId);
            
            if (tab) {
              try {
                if (tab.iframe.contentDocument) {
                  // Update tab title with page title
                  const title = tab.iframe.contentDocument.title;
                  updateTabInfo(tab, title);
                  
                  // Update document title with page title
                  document.title = title + ' - OFP Browser';
                } else {
                  // If we can't access contentDocument (CORS), use the URL hostname
                  try {
                    const hostname = new URL(tab.url).hostname;
                    updateTabInfo(tab, hostname);
                    document.title = hostname + ' - OFP Browser';
                  } catch (e) {
                    updateTabInfo(tab, 'New Tab');
                    document.title = 'OFP Browser';
                  }
                }
              } catch (e) {
                console.log("Title update error:", e);
              }
            }
          }
        }, true);
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
          // Ctrl+T: New tab
          if (e.ctrlKey && e.key === 't') {
            e.preventDefault();
            createTab();
          }
          
          // Ctrl+W: Close current tab
          if (e.ctrlKey && e.key === 'w') {
            e.preventDefault();
            if (activeTabId) {
              closeTab(activeTabId);
            }
          }
          
          // Ctrl+Tab: Next tab
          if (e.ctrlKey && e.key === 'Tab') {
            e.preventDefault();
            if (tabs.length > 1) {
              const currentIndex = tabs.findIndex(t => t.id === activeTabId);
              const nextIndex = (currentIndex + 1) % tabs.length;
              activateTab(tabs[nextIndex].id);
            }
          }
        });
      });

      // Lazy load the background animation
      window.addEventListener('load', () => {
        // Initialize stars background with a slight delay to prioritize UI
        setTimeout(() => {
          if (window.initStars && typeof window.initStars === 'function') {
            window.initStars();
          }
        }, 500);
      });
    </script>
  </body>
</html>
