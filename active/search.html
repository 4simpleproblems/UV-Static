<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>OFP Browser</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="icon" type="image/x-icon" href="logo.png" />
    <link rel="shortcut icon" type="image/jpg" href="logo.png" />
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap" rel="stylesheet" />
    <style>
      html, body {
        margin: 0;
        padding: 0;
        border: none;
        box-sizing: border-box;
        width: 100%;
        height: 100%;
        overflow: hidden;
        font-family: 'Roboto Mono', monospace;
        background-color: #1a1a1a;
        color: #fff;
      }
      
      body {
        display: flex;
        flex-direction: column;
      }
      
      /* Navigation Bar */
      #nav-bar {
        display: flex;
        align-items: center;
        padding: 12px;
        background-color: rgba(25, 25, 25, 0.8);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
      }
      
      .home-button {
        width: 38px;
        height: 38px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 10px;
        border-radius: 50%;
        background-color: rgba(35, 35, 35, 0.8);
        cursor: pointer;
        color: #fff;
        transition: background-color 0.2s, color 0.2s;
      }
      
      .home-button:hover {
        background-color: rgba(50, 50, 50, 0.9);
        color: #fff;
      }
      
      #search-bar {
        flex: 1;
        height: 40px;
        border-radius: 30px;
        border: none;
        background-color: rgba(20, 20, 20, 0.8);
        color: #fff;
        padding: 0 18px;
        font-size: 15px;
      }
      
      #search-bar:focus {
        outline: none;
        background-color: rgba(45, 45, 45, 0.9);
        box-shadow: 0 0 0 3px rgba(100, 100, 100, 0.5);
      }
      
      /* Fullscreen Button */
      .fullscreen-button {
        width: 38px;
        height: 38px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-left: 10px;
        border-radius: 50%;
        background-color: rgba(35, 35, 35, 0.8);
        cursor: pointer;
        color: #fff;
        transition: background-color 0.2s, color 0.2s;
      }
      
      .fullscreen-button:hover {
        background-color: rgba(50, 50, 50, 0.9);
        color: #fff;
      }
      
      /* Content Area */
      #content-area {
        flex: 1;
        width: 100%;
        border: none;
        background-color: #0;
      }
      
      /* Fullscreen Mode */
      .fullscreen-iframe {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 9999;
        border: none;
      }
      
      /* Footer Label */
      .footer-label {
        position: fixed;
        bottom: 0;
        left: 0;
        margin: 1rem;
        font-family: 'Roboto Mono', monospace;
        font-size: 0.9rem;
        color: #fff;
        text-decoration: none;
        z-index: 1000;
      }
      
      canvas {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
      }
    </style>
  </head>
  <body>
    <canvas id="canvas"></canvas>
    
    <div id="nav-bar">
      <div class="home-button" id="home-button" title="Home">
        <i class="fas fa-home"></i>
      </div>
      <input type="text" id="search-bar" placeholder="Search Google or type a URL">
      <div class="fullscreen-button" id="fullscreen-button" title="Toggle Fullscreen">
        <i class="fas fa-expand"></i>
      </div>
    </div>
    
    <iframe id="content-area" sandbox="allow-scripts allow-same-origin allow-forms allow-popups"></iframe>

    <a href="https://4simpleproblems.github.io/proxy-list.html" class="footer-label">Official 4SP Proxy</a>

    <script src="uv/uv.bundle.js"></script>
    <script src="uv/uv.config.js"></script>
    <script src="register-sw.js"></script>
    <script src="stars.js"></script>
    
    <script>
      // Initialize UV
      async function initUV() {
        try {
          await registerSW();
          console.log("Service worker registered");
        } catch (err) {
          console.error("Failed to register service worker:", err);
        }
      }
      
      // Navigate to URL
      function navigateTo(url) {
        if (!url) return;
        
        // Format URL if needed
        if (!/^https?:\/\//i.test(url) && !url.startsWith('about:')) {
          if (/^([a-z0-9]([a-z0-9-]*[a-z0-9])?\.)+[a-z]{2,}$/i.test(url) || 
              /^(\d{1,3}\.){3}\d{1,3}$/i.test(url)) {
            url = 'http://' + url;
          } else {
            url = 'https://www.google.com/search?q=' + encodeURIComponent(url);
          }
        }
        
        try {
          // Use Ultraviolet for proxying
          const encodedUrl = __uv$config.prefix + __uv$config.encodeUrl(url);
          document.getElementById('content-area').src = encodedUrl;
          document.getElementById('search-bar').value = url;
        } catch (err) {
          console.error("Navigation error:", err);
        }
      }
      
      // Toggle Fullscreen for iframe
      function toggleFullscreen() {
        const iframe = document.getElementById('content-area');
        const navBar = document.getElementById('nav-bar');
        const fullscreenButton = document.getElementById('fullscreen-button');
        const footerLabel = document.querySelector('.footer-label');
        
        if (iframe.classList.contains('fullscreen-iframe')) {
          // Exit fullscreen mode
          iframe.classList.remove('fullscreen-iframe');
          navBar.style.display = 'flex';
          footerLabel.style.display = 'block';
          fullscreenButton.innerHTML = '<i class="fas fa-expand"></i>';
        } else {
          // Enter fullscreen mode
          iframe.classList.add('fullscreen-iframe');
          navBar.style.display = 'none';
          footerLabel.style.display = 'none';
          fullscreenButton.innerHTML = '<i class="fas fa-compress"></i>';
          
          // Add escape key handler for exiting fullscreen
          document.addEventListener('keydown', function escKeyHandler(e) {
            if (e.key === 'Escape') {
              toggleFullscreen();
              document.removeEventListener('keydown', escKeyHandler);
            }
          });
        }
      }
      
      // Event Listeners
      document.addEventListener('DOMContentLoaded', async () => {
        await initUV();
        
        // Get URL from query parameter
        const urlParams = new URLSearchParams(window.location.search);
        const url = urlParams.get('url');
        
        // Navigate to URL if provided
        if (url) {
          navigateTo(url);
        }
        
        // Search bar
        document.getElementById('search-bar').addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            navigateTo(e.target.value);
          }
        });
        
        // Home button
        document.getElementById('home-button').addEventListener('click', () => {
          window.location.href = "index.html";
        });
        
        // Fullscreen button
        document.getElementById('fullscreen-button').addEventListener('click', () => {
          toggleFullscreen();
        });
        
        // Update page title when iframe loads
        document.getElementById('content-area').addEventListener('load', () => {
          const iframe = document.getElementById('content-area');
          
          try {
            // Try to get title from iframe
            if (iframe.contentDocument) {
              document.title = iframe.contentDocument.title + ' - OFP Browser';
            } else {
              // Cross-origin: use more generic title
              const currentUrl = document.getElementById('search-bar').value;
              try {
                const hostname = new URL(currentUrl).hostname;
                document.title = hostname + ' - OFP Browser';
              } catch (e) {
                document.title = 'OFP Browser';
              }
            }
          } catch (e) {
            console.log("Title update error:", e);
          }
        });
      });
    </script>
  </body>
</html>
